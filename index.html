<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport"    content="width=device-width,initial-scale=1">
    <meta name="description" content="Sistema corporativo de gestión y control de farmacias de la zona 1561">
    <meta name="theme-color" content="#1e3a8a">
    <title>Gestión Farmacias Zona 1561</title>

    <!-- Pre‑connect para Font Awesome -->
    <link rel="preconnect" href="https://cdnjs.cloudflare.com" crossorigin>
    <link rel="stylesheet" href="styles.css">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css"
          rel="stylesheet" integrity="sha512-..." crossorigin="anonymous">

    <!-- Scripts (deferred) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"
            defer></script>
    <script src="script.js" defer></script>
</head>

<body>
    <!-- ==================== HEADER ==================== -->
    <header class="header" role="banner">
        <div class="header-inner">
            <h1 class="app-title">
                <i class="fas fa-pills" aria-hidden="true"></i>
                <span>Gestión Farmacias Zona 1561</span>
            </h1>
            <p class="app-subtitle">Sistema corporativo de gestión y control</p>
        </div>
    </header>

    <main class="main-content" role="main">
        <!-- ==================== ESTADO DE CONEXIÓN ==================== -->
        <section class="connection-status" id="connectionStatus" aria-live="polite">
            <div class="status-card">
                <i class="fas fa-spinner fa-spin" id="statusIcon" aria-hidden="true"></i>
                <h3 id="statusTitle">Conectando…</h3>
                <p id="statusMessage">Inicializando sistema…</p>
            </div>
        </section>

        <!-- ==================== ESTADÍSTICAS ==================== -->
        <section class="stats-container" aria-label="Resumen de farmacias">
            <div class="stat-card">
                <i class="fas fa-store" aria-hidden="true"></i>
                <div class="stat-info">
                    <span class="stat-number" id="totalFarmacias">0</span>
                    <span class="stat-label">Farmacias</span>
                </div>
            </div>
            <div class="stat-card">
                <i class="fas fa-phone" aria-hidden="true"></i>
                <div class="stat-info">
                    <span class="stat-number" id="conTelefono">0</span>
                    <span class="stat-label">Con Teléfono</span>
                </div>
            </div>
            <div class="stat-card">
                <i class="fas fa-clock" aria-hidden="true"></i>
                <div class="stat-info">
                    <span class="stat-number" id="ultimaActualizacion">--:--</span>
                    <span class="stat-label">Última Actualización</span>
                </div>
            </div>
        </section>

        <!-- ==================== PANEL DE GESTIÓN ==================== -->
        <section class="management-panel" aria-labelledby="panelTitle">
            <header class="panel-header">
                <h2 id="panelTitle"><i class="fas fa-cogs" aria-hidden="true"></i> Panel de Gestión</h2>
                <div class="panel-actions">
                    <button type="button" class="btn btn-primary" data-action="show-add-modal">
                        <i class="fas fa-plus" aria-hidden="true"></i> Agregar Farmacia
                    </button>
                    <button type="button" class="btn btn-success" data-action="export-data">
                        <i class="fas fa-file-excel" aria-hidden="true"></i> Exportar
                    </button>
                    <button type="button" class="btn btn-info" data-action="load-farmacias">
                        <i class="fas fa-sync" aria-hidden="true"></i> Actualizar
                    </button>
                </div>
            </header>

            <!-- Búsqueda y filtros -->
            <div class="search-section">
                <div class="search-container" role="search">
                    <label for="searchInput" class="visually-hidden">Buscar farmacias</label>
                    <i class="fas fa-search" aria-hidden="true"></i>
                    <input type="search"
                           id="searchInput"
                           placeholder="Buscar por nombre, teléfono o descripción…"
                           autocomplete="off"
                           aria-label="Buscar por nombre, teléfono o descripción">
                </div>

                <div class="search-filters">
                    <label for="filterTelefono" class="visually-hidden">Filtro por teléfono</label>
                    <select id="filterTelefono" aria-label="Filtrar por disponibilidad de teléfono">
                        <option value="">Todos</option>
                        <option value="con">Con Teléfono</option>
                        <option value="sin">Sin Teléfono</option>
                    </select>
                </div>
            </div>

            <!-- Lista de farmacias -->
            <div class="farmacia-list">
                <div class="table-container">
                    <table class="farmacia-table" aria-describedby="farmaciaTableDesc">
                        <caption id="farmaciaTableDesc" class="visually-hidden">
                            Lista de farmacias con acciones de edición y eliminación
                        </caption>
                        <thead>
                            <tr>
                                <th scope="col">Nombre</th>
                                <th scope="col">Teléfono</th>
                                <th scope="col">Descripción</th>
                                <th scope="col">Acciones</th>
                            </tr>
                        </thead>
                        <tbody id="farmaciaTableBody">
                            <!-- Filas generadas dinámicamente -->
                        </tbody>
                    </table>
                </div>

                <div id="emptyState" class="empty-state" role="status" aria-live="polite" hidden>
                    <i class="fas fa-store" aria-hidden="true"></i>
                    <h3>No hay farmacias registradas</h3>
                    <p>Comienza agregando tu primera farmacia</p>
                    <button type="button" class="btn btn-primary" data-action="show-add-modal">
                        <i class="fas fa-plus" aria-hidden="true"></i> Agregar Primera Farmacia
                    </button>
                </div>
            </div>
        </section>

        <!-- ==================== MODAL DE AGREGAR / EDITAR ==================== -->
        <dialog id="farmaciaModal" class="modal" aria-labelledby="modalTitle">
            <form id="farmaciaForm" novalidate>
                <header class="modal-header">
                    <h3 id="modalTitle">Agregar Farmacia</h3>
                    <button type="button" class="close" data-action="close-modal" aria-label="Cerrar">
                        &times;
                    </button>
                </header>

                <div class="modal-body">
                    <div class="form-group">
                        <label for="farmaciaNombre">
                            <i class="fas fa-store" aria-hidden="true"></i>
                            Nombre de la Farmacia <span aria-hidden="true">*</span>
                        </label>
                        <input type="text"
                               id="farmaciaNombre"
                               name="nombre"
                               required
                               autocomplete="organization"
                               placeholder="Ej: Farmacia San Rafael">
                    </div>

                    <div class="form-group">
                        <label for="farmaciaTelefono">
                            <i class="fas fa-phone" aria-hidden="true"></i>
                            Teléfono
                        </label>
                        <input type="tel"
                               id="farmaciaTelefono"
                               name="telefono"
                               autocomplete="tel"
                               placeholder="Ej: 3001234567">
                    </div>

                    <div class="form-group">
                        <label for="farmaciaDescripcion">
                            <i class="fas fa-clipboard-list" aria-hidden="true"></i>
                            Descripción
                        </label>
                        <textarea id="farmaciaDescripcion"
                                  name="descripcion"
                                  rows="4"
                                  placeholder="Información adicional, horarios, contactos, observaciones..."></textarea>
                    </div>
                </div>

                <footer class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-action="close-modal">
                        <i class="fas fa-times" aria-hidden="true"></i> Cancelar
                    </button>
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-save" aria-hidden="true"></i> Guardar
                    </button>
                </footer>
            </form>
        </dialog>

        <!-- ==================== REGISTRO DE ACTIVIDADES ==================== -->
        <section class="activity-section" aria-labelledby="activityTitle">
            <h3 id="activityTitle"><i class="fas fa-list" aria-hidden="true"></i> Registro de Actividades</h3>
            <ul id="logContainer" class="log-container" aria-live="polite"></ul>
            <button type="button" class="btn btn-secondary" data-action="clear-log">
                <i class="fas fa-broom" aria-hidden="true"></i> Limpiar Registro
            </button>
        </section>
    </main>

    <!-- ==================== FOOTER ==================== -->
    <footer class="footer" role="contentinfo">
        <div class="footer-inner">
            <p>&copy; <span id="currentYear"></span> Gestión Farmacias Zona 1561 — Hecho con <span aria-hidden="true">❤️</span> para tu negocio</p>
        </div>
    </footer>

    <!-- ==================== FIREBASE (Módulo) ==================== -->
    <script type="module">
        try {
            console.log('🚀 Iniciando Firebase…');

            const { initializeApp } = await import('https://www.gstatic.com/firebasejs/11.9.1/firebase-app.js');
            const {
                getFirestore,
                collection,
                addDoc,
                getDocs,
                updateDoc,
                deleteDoc,
                doc,
                query,
                orderBy
            } = await import('https://www.gstatic.com/firebasejs/11.9.1/firebase-firestore.js');

            const firebaseConfig = {
                apiKey:            'AIzaSyAaVSb70OFIoX48T9GbLmTcdXOSvKv2pRk',
                authDomain:        'zona1561-4de30.firebaseapp.com',
                projectId:         'zona1561-4de30',
                storageBucket:     'zona1561-4de30.firebasestorage.app',
                messagingSenderId: '451366030738',
                appId:             '1:451366030738:web:e638db51fbe24f6a48054b'
            };

            const app = initializeApp(firebaseConfig);
            const db  = getFirestore(app);

            // Exponer API mínima para el resto del código
            window.firebase = {
                db,
                collection,
                addDoc,
                getDocs,
                updateDoc,
                deleteDoc,
                doc,
                query,
                orderBy
            };
            window.dispatchEvent(new CustomEvent('firebaseReady'));

            console.log('🔥 Firebase listo');
        } catch (e) {
            console.error('❌ Error al iniciar Firebase', e);
            window.dispatchEvent(new CustomEvent('firebaseError', {detail:e}));
        }
    </script>

    <!-- Script de utilidad para el año del footer -->
    <script defer>
        document.getElementById('currentYear').textContent = new Date().getFullYear();
    </script>
</body>
</html>

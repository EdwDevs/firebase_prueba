rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // ==================== FUNCIONES AUXILIARES ====================
    
    function isAuthenticated() {
      return request.auth != null;
    }
    
    function hasTenantClaim(tenantId) {
      return request.auth.token.tenantId == tenantId;
    }

    function getUserDoc(tenantId) {
      return get(/databases/$(database)/documents/tenants/$(tenantId)/users/$(request.auth.uid));
    }

    function hasUserDoc(tenantId) {
      return exists(/databases/$(database)/documents/tenants/$(tenantId)/users/$(request.auth.uid));
    }

    function getUserRole(tenantId) {
      return hasUserDoc(tenantId) ? getUserDoc(tenantId).data.role : null;
    }
    
    function isAdmin(tenantId) {
      return isAuthenticated() && (request.auth.token.role == 'admin' || getUserRole(tenantId) == 'admin');
    }
    
    function isCashier(tenantId) {
      return isAuthenticated() && (request.auth.token.role == 'cashier' || getUserRole(tenantId) == 'cashier');
    }
    
    function isWaiter(tenantId) {
      return isAuthenticated() && (request.auth.token.role == 'waiter' || getUserRole(tenantId) == 'waiter');
    }
    
    function isStaff(tenantId) {
      return isAdmin(tenantId) || isCashier(tenantId) || isWaiter(tenantId);
    }
    
    function belongsToTenant(tenantId) {
      return isAuthenticated() && (hasTenantClaim(tenantId) || hasUserDoc(tenantId));
    }
    
    function isOwner(userId) {
      return isAuthenticated() && request.auth.uid == userId;
    }
    
    // ==================== TENANT ISOLATION ====================
    
    match /tenants/{tenantId}/{document=**} {
      allow read, write: if belongsToTenant(tenantId);
    }
    
    // ==================== USUARIOS ====================
    
    match /tenants/{tenantId}/users/{userId} {
      allow read: if isOwner(userId) ||
        (belongsToTenant(tenantId) && resource.data.tenantId == tenantId);
      
      // Solo admin puede crear/modificar usuarios
      allow create: if (isAdmin(tenantId) && request.resource.data.tenantId == tenantId) ||
        (isOwner(userId) &&
          request.resource.data.tenantId == tenantId &&
          request.resource.data.role == 'waiter' &&
          request.resource.data.displayName is string &&
          request.resource.data.keys().hasOnly(['role', 'displayName', 'tenantId']));
      
      allow update: if isAdmin(tenantId) && 
        request.resource.data.tenantId == tenantId;
      
      allow delete: if isAdmin(tenantId);
    }
    
    // ==================== MESAS ====================
    
    match /tenants/{tenantId}/tables/{tableId} {
      allow read: if belongsToTenant(tenantId);
      allow write: if isAdmin(tenantId); // Solo admin configura mesas
    }
    
    // ==================== PRODUCTOS Y CATEGORÍAS ====================
    
    match /tenants/{tenantId}/products/{productId} {
      allow read: if belongsToTenant(tenantId);
      allow write: if isAdmin(tenantId);
    }
    
    match /tenants/{tenantId}/categories/{categoryId} {
      allow read: if belongsToTenant(tenantId);
      allow write: if isAdmin(tenantId);
    }
    
    match /tenants/{tenantId}/modifierGroups/{groupId} {
      allow read: if belongsToTenant(tenantId);
      allow write: if isAdmin(tenantId);
    }
    
    // ==================== ÓRDENES ====================
    
    match /tenants/{tenantId}/orders/{orderId} {
      allow read: if belongsToTenant(tenantId);
      
      // Crear orden: mesero, cajero o admin
      allow create: if belongsToTenant(tenantId) && 
        (isWaiter(tenantId) || isCashier(tenantId) || isAdmin(tenantId)) &&
        request.resource.data.status == 'open' &&
        request.resource.data.paymentStatus == 'pending';
      
      // Actualizar orden abierta: mesero puede modificar items
      allow update: if belongsToTenant(tenantId) && (
        // Admin puede todo
        isAdmin(tenantId) ||
        // Cajero puede cobrar (cambiar estado a paid)
        (isCashier(tenantId) && 
         resource.data.status == 'open' && 
         request.resource.data.status == 'paid') ||
        // Mesero puede modificar orden abierta
        (isWaiter(tenantId) && 
         resource.data.status == 'open' && 
         request.resource.data.status == 'open')
      );
      
      allow delete: if isAdmin(tenantId);
    }
    
    // ==================== ITEMS DE ORDEN ====================
    
    match /tenants/{tenantId}/orders/{orderId}/orderItems/{itemId} {
      allow read: if belongsToTenant(tenantId);
      
      allow create, update, delete: if belongsToTenant(tenantId) && 
        (isWaiter(tenantId) || isCashier(tenantId) || isAdmin(tenantId)) &&
        get(/databases/$(database)/documents/tenants/$(tenantId)/orders/$(orderId)).data.status == 'open';
    }
    
    // ==================== BARRA (TICKETS) ====================
    
    match /tenants/{tenantId}/barTickets/{ticketId} {
      allow read: if belongsToTenant(tenantId);
      
      // Cualquier staff puede marcar como listo
      allow update: if belongsToTenant(tenantId) && 
        (isWaiter(tenantId) || isCashier(tenantId) || isAdmin(tenantId)) &&
        request.resource.data.status in ['preparing', 'ready'];
    }
    
    // ==================== CAJA ====================
    
    match /tenants/{tenantId}/cashSessions/{sessionId} {
      allow read: if belongsToTenant(tenantId);
      
      // Abrir turno: cajero o admin
      allow create: if belongsToTenant(tenantId) && 
        (isCashier(tenantId) || isAdmin(tenantId)) &&
        request.resource.data.isActive == true;
      
      // Cerrar turno: cajero o admin
      allow update: if belongsToTenant(tenantId) && 
        (isCashier(tenantId) || isAdmin(tenantId)) &&
        resource.data.isActive == true &&
        request.resource.data.isActive == false;
    }
    
    // ==================== INVENTARIO ====================
    
    match /tenants/{tenantId}/inventoryItems/{itemId} {
      allow read: if belongsToTenant(tenantId);
      allow write: if isAdmin(tenantId) || isCashier(tenantId); // Cajero puede ajustar
    }
    
    match /tenants/{tenantId}/inventoryMovements/{movementId} {
      allow read: if belongsToTenant(tenantId);
      allow create: if belongsToTenant(tenantId) && 
        (isAdmin(tenantId) || isCashier(tenantId));
    }
    
    // ==================== CONFIGURACIÓN ====================
    
    match /tenants/{tenantId}/config/{document=**} {
      allow read: if belongsToTenant(tenantId);
      allow write: if isAdmin(tenantId);
    }
    
    // ==================== AUDIT LOGS (SOLO APPEND) ====================
    
    match /tenants/{tenantId}/auditLogs/{logId} {
      allow read: if isAdmin(tenantId);
      allow create: if belongsToTenant(tenantId);
      allow update, delete: if false;
    }
  }
}

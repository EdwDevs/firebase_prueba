rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // ==================== FUNCIONES AUXILIARES ====================
    
    function isAuthenticated() {
      return request.auth != null;
    }
    
    function getUserData() {
      return get(/databases/$(database)/documents/tenants/$(request.auth.token.tenantId)/users/$(request.auth.uid)).data;
    }
    
    function getTenantId() {
      return request.auth.token.tenantId;
    }
    
    function isAdmin() {
      return isAuthenticated() && request.auth.token.role == 'admin';
    }
    
    function isCashier() {
      return isAuthenticated() && request.auth.token.role == 'cashier';
    }
    
    function isWaiter() {
      return isAuthenticated() && request.auth.token.role == 'waiter';
    }
    
    function isStaff() {
      return isAdmin() || isCashier() || isWaiter();
    }
    
    function belongsToTenant(tenantId) {
      return isAuthenticated() && getTenantId() == tenantId;
    }
    
    function isOwner(userId) {
      return isAuthenticated() && request.auth.uid == userId;
    }
    
    // ==================== TENANT ISOLATION ====================
    
    match /tenants/{tenantId}/{document=**} {
      allow read, write: if belongsToTenant(tenantId);
    }
    
    // ==================== USUARIOS ====================
    
    match /tenants/{tenantId}/users/{userId} {
      allow read: if belongsToTenant(tenantId);
      
      // Solo admin puede crear/modificar usuarios
      allow create, update: if isAdmin() && 
        request.resource.data.tenantId == tenantId;
      
      allow delete: if isAdmin();
    }
    
    // ==================== MESAS ====================
    
    match /tenants/{tenantId}/tables/{tableId} {
      allow read: if belongsToTenant(tenantId);
      allow write: if isAdmin(); // Solo admin configura mesas
    }
    
    // ==================== PRODUCTOS Y CATEGORÍAS ====================
    
    match /tenants/{tenantId}/products/{productId} {
      allow read: if belongsToTenant(tenantId);
      allow write: if isAdmin();
    }
    
    match /tenants/{tenantId}/categories/{categoryId} {
      allow read: if belongsToTenant(tenantId);
      allow write: if isAdmin();
    }
    
    match /tenants/{tenantId}/modifierGroups/{groupId} {
      allow read: if belongsToTenant(tenantId);
      allow write: if isAdmin();
    }
    
    // ==================== ÓRDENES ====================
    
    match /tenants/{tenantId}/orders/{orderId} {
      allow read: if belongsToTenant(tenantId);
      
      // Crear orden: mesero, cajero o admin
      allow create: if belongsToTenant(tenantId) && 
        (isWaiter() || isCashier() || isAdmin()) &&
        request.resource.data.status == 'open' &&
        request.resource.data.paymentStatus == 'pending';
      
      // Actualizar orden abierta: mesero puede modificar items
      allow update: if belongsToTenant(tenantId) && (
        // Admin puede todo
        isAdmin() ||
        // Cajero puede cobrar (cambiar estado a paid)
        (isCashier() && 
         resource.data.status == 'open' && 
         request.resource.data.status == 'paid') ||
        // Mesero puede modificar orden abierta
        (isWaiter() && 
         resource.data.status == 'open' && 
         request.resource.data.status == 'open')
      );
      
      allow delete: if isAdmin();
    }
    
    // ==================== ITEMS DE ORDEN ====================
    
    match /tenants/{tenantId}/orders/{orderId}/orderItems/{itemId} {
      allow read: if belongsToTenant(tenantId);
      
      allow create, update, delete: if belongsToTenant(tenantId) && 
        (isWaiter() || isCashier() || isAdmin()) &&
        get(/databases/$(database)/documents/tenants/$(tenantId)/orders/$(orderId)).data.status == 'open';
    }
    
    // ==================== BARRA (TICKETS) ====================
    
    match /tenants/{tenantId}/barTickets/{ticketId} {
      allow read: if belongsToTenant(tenantId);
      
      // Cualquier staff puede marcar como listo
      allow update: if belongsToTenant(tenantId) && 
        (isWaiter() || isCashier() || isAdmin()) &&
        request.resource.data.status in ['preparing', 'ready'];
    }
    
    // ==================== CAJA ====================
    
    match /tenants/{tenantId}/cashSessions/{sessionId} {
      allow read: if belongsToTenant(tenantId);
      
      // Abrir turno: cajero o admin
      allow create: if belongsToTenant(tenantId) && 
        (isCashier() || isAdmin()) &&
        request.resource.data.isActive == true;
      
      // Cerrar turno: cajero o admin
      allow update: if belongsToTenant(tenantId) && 
        (isCashier() || isAdmin()) &&
        resource.data.isActive == true &&
        request.resource.data.isActive == false;
    }
    
    // ==================== INVENTARIO ====================
    
    match /tenants/{tenantId}/inventoryItems/{itemId} {
      allow read: if belongsToTenant(tenantId);
      allow write: if isAdmin() || isCashier(); // Cajero puede ajustar
    }
    
    match /tenants/{tenantId}/inventoryMovements/{movementId} {
      allow read: if belongsToTenant(tenantId);
      allow create: if belongsToTenant(tenantId) && 
        (isAdmin() || isCashier());
    }
    
    // ==================== CONFIGURACIÓN ====================
    
    match /tenants/{tenantId}/config/{document=**} {
      allow read: if belongsToTenant(tenantId);
      allow write: if isAdmin();
    }
    
    // ==================== AUDIT LOGS (SOLO APPEND) ====================
    
    match /tenants/{tenantId}/auditLogs/{logId} {
      allow read: if isAdmin();
      allow create: if belongsToTenant(tenantId);
      allow update, delete: if false;
    }
  }
}
